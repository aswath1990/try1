const rows = 3;
const cols = 4;
const frontImage = 'front.png';
const backImage = 'back.png';
const puzzleContainer = document.getElementById('puzzleContainer');
const countdownDisplay = document.getElementById('countdown');
const downloadButton = document.getElementById('downloadButton');

const UNLOCK_INTERVAL = 900; // 15 minutes in seconds
const unlockOrder = [3, 7, 11]; // Unlock order of tiles
let unlockIndex = 0;

// ✅ Fix: Get accurate PST time
function getPSTTimestamp() {
    return new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" });
}

// ✅ Fix: Convert to valid timestamp
function getPSTTimeInMs() {
    return new Date(getPSTTimestamp()).getTime();
}

// ✅ Fix: Store and retrieve timestamp correctly
let DEPLOYMENT_TIMESTAMP = localStorage.getItem('DEPLOYMENT_TIMESTAMP');
if (!DEPLOYMENT_TIMESTAMP || isNaN(DEPLOYMENT_TIMESTAMP)) {
    DEPLOYMENT_TIMESTAMP = getPSTTimeInMs();
    localStorage.setItem('DEPLOYMENT_TIMESTAMP', DEPLOYMENT_TIMESTAMP);
} else {
    DEPLOYMENT_TIMESTAMP = parseInt(DEPLOYMENT_TIMESTAMP, 10);
}

// ✅ Fix: Unlock multiple tiles correctly
function unlockNextTile() {
    const elapsedSeconds = Math.floor((getPSTTimeInMs() - DEPLOYMENT_TIMESTAMP) / 1000);
    unlockIndex = Math.floor(elapsedSeconds / UNLOCK_INTERVAL);

    for (let i = 0; i <= unlockIndex && i < unlockOrder.length; i++) {
        const nextTile = unlockOrder[i];
        const tileElement = document.querySelector(`.tile[data-index='${nextTile}']`);
        if (tileElement) tileElement.style.visibility = 'visible';
    }

    if (unlockIndex >= unlockOrder.length) {
        clearInterval(intervalId);
        countdownDisplay.textContent = "All Memories Unlocked!";
        downloadButton.style.display = 'block';
    }
}

// ✅ Fix: Correct countdown logic
function updateCountdown() {
    const currentTime = getPSTTimeInMs();
    const nextUnlockTime = DEPLOYMENT_TIMESTAMP + (unlockIndex + 1) * UNLOCK_INTERVAL * 1000;
    const countdown = Math.max(0, Math.floor((nextUnlockTime - currentTime) / 1000));

    const minutes = Math.floor(countdown / 60);
    const seconds = countdown % 60;

    countdownDisplay.textContent = `My Next Sweet Memory Will Show In: ${minutes}m ${seconds}s`;

    if (countdown <= 0) {
        unlockNextTile();
    }
}

// ✅ Fix: Ensure countdown updates properly
const intervalId = setInterval(updateCountdown, 1000);

for (let i = 0; i < rows * cols; i++) {
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.dataset.index = i;

    if ([0, 1, 2, 4, 5, 6, 8, 9, 10].includes(i)) {
        tile.style.visibility = 'visible';
    }

    const flipCard = document.createElement('div');
    flipCard.className = 'flip-card';

    const front = document.createElement('div');
    front.className = 'front';
    front.style.backgroundImage = `url(${frontImage})`;
    front.style.backgroundSize = `${cols * 100}px ${rows * 100}px`;
    front.style.backgroundPosition = `-${(i % cols) * 100}px -${Math.floor(i / cols) * 100}px`;

    const back = document.createElement('div');
    back.className = 'back';
    back.style.backgroundImage = `url(${backImage})`;
    back.style.backgroundSize = `${cols * 100}px ${rows * 100}px`;
    back.style.backgroundPosition = `-${(i % cols) * 100}px -${Math.floor(i / cols) * 100}px`;

    flipCard.appendChild(front);
    flipCard.appendChild(back);
    tile.appendChild(flipCard);

    const audio = new Audio(`https://raw.githubusercontent.com/aswath1990/audio/main/tile${i}.mp3`);
    audio.preload = 'auto';

    audio.addEventListener('error', () => {
        console.error(`Audio file for tile${i}.mp3 not found.`);
    });

    tile.addEventListener('click', () => {
        tile.classList.toggle('flipped');

        if (currentAudio && currentAudio !== audio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }

        if (currentAudio !== audio || audio.paused) {
            audio.play();
        }

        currentAudio = audio;
    });

    puzzleContainer.appendChild(tile);
}

// ✅ Fix: Correct image download function
function downloadImages() {
    const link1 = document.createElement('a');
    link1.href = frontImage;
    link1.download = 'front.png';
    link1.click();

    const link2 = document.createElement('a');
    link2.href = backImage;
    link2.download = 'back.png';
    link2.click();
}

// ✅ Call unlock function on page load
unlockNextTile();
